# Runbook - 2025-10-18

## Session Summary
Working on ihome.zentala.io Hugo blog - fixing production issues, optimizing CI/CD, and improving documentation.

---

## 1. Fixed Kroki Diagrams 403 Forbidden Errors in GitHub Actions

**Problem:** Hugo build failing with "failed to fetch remote resource: Forbidden" when fetching diagrams from kroki.io API

**Root Cause:**
- GitHub Actions fetching diagrams on every build
- Rate limiting from kroki.io (100 req/min)
- No persistent cache between builds

**Solution:**
```toml
# config/_default/hugo.toml
[caches.getresource]
  dir = ":resourceDir/_gen"
  maxAge = -1  # Never expire, invalidate on content change
```

**Steps:**
1. Added cache config to `hugo.toml`
2. Updated `.gitignore` to commit `resources/_gen/getresource/`
3. Built locally to generate 54 cached SVG diagrams
4. Committed cached resources to repo

**Result:**
- ‚úÖ GitHub Actions build: 3 errors ‚Üí 0 errors
- ‚úÖ Build time: 50s (stable)
- ‚úÖ No more API calls to kroki.io

**Files Changed:**
- `config/_default/hugo.toml`
- `.gitignore`
- `resources/_gen/getresource/*` (54 cached diagrams)

**Commit:** `4f27114` - "fix(build): cache Kroki diagrams to fix GitHub Actions 403 errors"

---

## 2. Hide Dev-Only Elements in Production

**Problem:** "Markdown Demo" link and draft toggle (eye icon) visible on production site

**Solution:** Use `hugo.Environment` for dev/prod detection

**Implementation:**

### Footer - Demo Link
```toml
# config/_default/menus/menus.pl.toml
[[footer]]
  name = "Markdown Demo"
  url = "/demo/"
  weight = 20
  [footer.params]
    devOnly = true  # Flag for dev-only items
```

```html
<!-- layouts/partials/footer/footer.html -->
{{ range .Site.Menus.footer -}}
  {{- $showLink := true -}}
  {{- if .Params.devOnly -}}
    {{- if eq hugo.Environment "production" -}}
      {{- $showLink = false -}}
    {{- end -}}
  {{- end -}}
  {{- if $showLink -}}
  <li>...</li>
  {{- end -}}
{{- end }}
```

### Header - Draft Toggle
```html
<!-- layouts/partials/header/header.html -->
<!-- Draft toggle (dev only) -->
{{ if ne hugo.Environment "production" -}}
<button type="button" id="draftToggle" class="draft-toggle">
  <!-- eye icon -->
</button>
{{ end -}}
```

**Result:**
- ‚úÖ Demo link hidden on production
- ‚úÖ Draft toggle hidden on production
- ‚úÖ DRY principle - one detection mechanism

**Files Changed:**
- `config/_default/menus/menus.pl.toml`
- `layouts/partials/footer/footer.html`
- `layouts/partials/header/header.html`

**Commit:** `0d1fab5` - "feat: hide dev-only elements in production and update copyright"

---

## 3. Dynamic Copyright Year

**Problem:** Copyright showing "2024" instead of "2004-{current year}"

**Initial Attempt (FAILED):**
```toml
# config/_default/languages.toml
footer = 'Copyright &copy; 2004-{{ now.Year }} ...'
```
‚ùå Hugo template syntax doesn't work in TOML config files!

**Correct Solution:**
```html
<!-- layouts/partials/footer/footer.html -->
<li class="list-inline-item">
  Copyright &copy; 2004-{{ now.Year }}
  <a class="text-muted" href="https://zentala.io/" target="_blank">Pawe≈Ç ≈ªenta≈Ça</a>
</li>
```

**Result:**
- ‚úÖ Shows "Copyright ¬© 2004-2025"
- ‚úÖ Auto-updates every year

**Files Changed:**
- `config/_default/languages.toml` (removed footer param)
- `layouts/partials/footer/footer.html` (added dynamic rendering)

**Commit:** `c874f98` - "fix(footer): render copyright year dynamically in template"

---

## 4. Documentation Refactoring

**Goal:** Separate marketing (README) from developer docs (CONTRIBUTING)

**Changes:**

### README.md (simplified)
- Added link: "This blog" ‚Üí https://ihome.zentala.io/
- Added "AI Development Ready" section
- Moved all technical details to CONTRIBUTING.md
- Fixed typo: "Hays" ‚Üí "Hyas"

### CONTRIBUTING.md (new file)
- Requirements, Quick Start, Commands
- AI Development section:
  - Claude Code - dev/deployment/debugging
  - Cursor IDE - content writing/blog posts
  - VS Code - manual editing
- Workflow recommendations table
- Troubleshooting guide

**Files Changed:**
- `README.md` (shortened from 132 to 31 lines)
- `CONTRIBUTING.md` (new, 120 lines)

**Commit:** `9d909b3` - "docs: refactor documentation structure and add AI development guide"

---

## 5. CI/CD Performance Optimization

**Goal:** Speed up GitHub Actions builds

**Implementation:**
```yaml
# .github/workflows/deploy.yml
- name: Get pnpm store directory
  run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

- name: Setup pnpm cache
  uses: actions/cache@v4
  with:
    path: ${{ env.STORE_PATH }}
    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
    restore-keys: |
      ${{ runner.os }}-pnpm-store-
```

**Expected Result:**
- First build: 50s (creates cache)
- Subsequent builds: 25-30s (uses cache)

**Actual Results:**
- Build #1: 50s (no cache)
- Build #2: 47s (creating cache)
- Build #3: 55s (cache might not have worked due to network)
- Next builds: TBD (cache should work)

**Files Changed:**
- `.github/workflows/deploy.yml`

**Commit:** `8dc14d5` - "perf(ci): add pnpm store cache and document tech improvements"

---

## 6. Tech Improvements Documentation

**Created:** `.cursor/todo/tech-improvements.md`

**Contents:**
- Explanation of Hugo Archetypes (content templates)
- Explanation of Related Content (SEO interlinking)
- Future ideas: Lighthouse CI, Dependabot, ADR
- Priority matrix

**Purpose:** Knowledge base for future improvements

---

## 7. Cleanup & Security

### .gitignore Improvements
```gitignore
# Logs
*.log
*.log.*
gh-action-log.txt

# Local env files
.env.local
.env.*.local

# Downloaded binaries and archives
*.zip
*.tar.gz
*.exe
hugo
hugo.exe
```

**Commits:**
- `3a13bf8` - "chore: improve .gitignore - add log files and local env patterns"
- (pending) - Remove hugo.zip from repo

---

## 8. Hugo.zip Cleanup (In Progress)

**Problem:** 21MB `hugo.zip` file committed in git history (commit 18397b1, Oct 12)

**Steps Taken:**
1. ‚úÖ Removed `hugo.zip` from working directory
2. ‚úÖ Added `*.zip`, `*.tar.gz`, `*.exe`, `hugo`, `hugo.exe` to `.gitignore`
3. ‚è≥ Need to remove from git history using BFG

**TODO:**
```bash
# Option 1: BFG (recommended)
git clone --mirror https://github.com/zentala/ihome.zentala.io.git
bfg --delete-files hugo.zip ihome.zentala.io.git
cd ihome.zentala.io.git
git reflog expire --expire=now --all && git gc --prune=now --aggressive
git push

# Option 2: git filter-repo (alternative)
git filter-repo --path hugo.zip --invert-paths
```

**Why This Matters:**
- 21MB in git history slows down clones
- Unnecessary binary in repo
- Hugo installed via `hugo-installer` package anyway

---

## Key Learnings

1. **Hugo Config Limitations:** Template syntax (`{{ now.Year }}`) doesn't work in TOML config files - must use in templates
2. **Cache Strategy:** For external resources, commit cached files to repo for CI/CD reliability
3. **DRY Detection:** Use `hugo.Environment` for consistent dev/prod detection across all templates
4. **Git Hygiene:** Always check for large files before committing, use .gitignore patterns proactively

---

## Build Performance Tracking

| Date | Commit | Build Time | Cache Status | Notes |
|------|--------|------------|--------------|-------|
| 2025-10-18 | 4f27114 | 50s | No cache | Kroki fix baseline |
| 2025-10-18 | 0d1fab5 | 50s | No cache | Dev elements hidden |
| 2025-10-18 | 8dc14d5 | 47s | Creating | pnpm cache setup |
| 2025-10-18 | c874f98 | 55s | ??? | Copyright fix |

**Target:** 25-30s with pnpm cache working

---

## Files Modified Summary

**Config:**
- `config/_default/hugo.toml` - Kroki cache
- `config/_default/languages.toml` - Removed footer param
- `config/_default/menus/menus.pl.toml` - devOnly flag
- `.gitignore` - Logs, env, binaries

**Templates:**
- `layouts/partials/footer/footer.html` - Dev detection, dynamic copyright
- `layouts/partials/header/header.html` - Dev detection for draft toggle

**Docs:**
- `README.md` - Simplified, marketing focus
- `CONTRIBUTING.md` - New, technical details
- `.cursor/todo/tech-improvements.md` - New, future ideas

**CI/CD:**
- `.github/workflows/deploy.yml` - pnpm cache

**Resources:**
- `resources/_gen/getresource/*` - 54 cached Kroki diagrams

---

## Next Session TODO

1. ‚ö†Ô∏è Remove hugo.zip from git history (BFG or filter-repo)
2. üìä Monitor pnpm cache effectiveness on next build
3. üéØ Consider implementing Hugo Archetypes (see tech-improvements.md)
4. üîó Evaluate Related Content implementation for SEO

---

## 9. Runbook Structure Refactor

**Change:** Moved from nested folders to flat structure

**Before:** `.claude/runbook/2025/10/18.md` (with year/month subfolders)
**After:** `.claude/runbooks/2025-10-18.md` (flat, sortable by filename)

**Reason:**
- Simpler file organization
- Easier to find: just sort by date
- Less directory clutter

**Files Changed:**
- `.claude/CLAUDE.md` - Updated runbook protocol to use `YYYY-MM-DD.md` format
- Moved & updated this runbook file

**Command:**
```bash
mkdir -p .claude/runbooks
mv .claude/runbook/2025/10/18.md .claude/runbooks/2025-10-18.md
rm -rf .claude/runbook
```

---

## 10. Removed hugo.zip from Git History

**Problem:** 21MB `hugo.zip` file in git history (commit 18397b1, Oct 12)

**Impact:**
- Slowed down `git clone`
- Wasted 21MB in every clone
- Unnecessary binary (Hugo installed via npm package anyway)

**Solution: git filter-branch**
```bash
# Step 1: Remove from all commits
git filter-branch --force --index-filter \
  'git rm --cached --ignore-unmatch hugo.zip' \
  --prune-empty --tag-name-filter cat -- --all

# Step 2: Cleanup references
rm -rf .git/refs/original/
git reflog expire --expire=now --all
git gc --prune=now --aggressive

# Step 3: Force push (rewrites history!)
git push origin main --force
```

**Result:**
- ‚úÖ `hugo.zip` removed from all 17 commits
- ‚úÖ Repo size reduced (13.86 MiB pack)
- ‚úÖ History cleaned
- ‚úÖ Force pushed to GitHub

**Verification:**
```bash
git rev-list --objects --all | grep hugo.zip
# Output: (nothing) = success!

git count-objects -vH
# size-pack: 13.86 MiB (was larger before)
```

**Warning for team:**
‚ö†Ô∏è Anyone who has cloned the repo needs to:
```bash
git fetch origin
git reset --hard origin/main
```

**Files Changed:**
- Git history (57 commits rewritten)
- `.git/` internals cleaned up

**Commit:** `a69188a` (forced update after filter-branch)

---

## 11. Hugo Archetypes Implementation

**Goal:** Create useful content templates for Blog, Tutorials, and Docs with Polish labels and helpful structure

**Problem:**
- Existing archetypes were minimal, no helpful comments or structure
- No easy way to create content from VS Code (had to type Hugo commands manually)
- Missing Polish context (categories, tags suggestions)

**Solution:**

### Enhanced Archetypes

**archetypes/blog.md**
- Added Polish category suggestions: Mieszkanie, Instalacja, Wnƒôtrza, Wyposa≈ºenie, Smart Home
- Added Polish tag suggestions: elektryka, automatyka, IoT, DIY, projektowanie, zakupy
- Added helpful comments explaining each field
- Added content structure: Wprowadzenie, G≈Ç√≥wna tre≈õƒá, Podsumowanie
- Added `thumb` field for thumbnail images

**archetypes/tutorials.md**
- Tutorial-specific categories: Elektryka, Instalacja, Konfiguracja, Bezpiecze≈Ñstwo, Optymalizacja
- Tutorial-specific tags: krok-po-kroku, DIY, smart-home, instalacja, narzƒôdzia
- Step-by-step structure template:
  - Czego siƒô nauczysz?
  - Wymagania (lista narzƒôdzi/umiejƒôtno≈õci)
  - Krok 1, 2, 3...
  - Podsumowanie
  - Co dalej?

**archetypes/docs.md**
- Documentation structure template:
  - Wprowadzenie
  - Zastosowanie
  - Typy i rodzaje
  - Specyfikacja techniczna
  - Instalacja
  - Konfiguracja
  - Polecane produkty
  - Zobacz tak≈ºe
- Added helpful comments for menu parent (e.g., "actuators", "sensors", "cables")
- Added contributors field

### VS Code Tasks

Added 3 new tasks to `.vscode/tasks.json`:

1. **Create New Blog Post**
   - Step 1: Choose category from dropdown (flat, instalacja, interior-design, wyposarzenie)
   - Step 2: Enter filename (e.g., "moj-nowy-post")
   - Result: Creates `blog/{category}/{filename}.md`

2. **Create New Tutorial**
   - Step 1: Enter tutorial slug (e.g., "instalacja-gniazdek")
   - Result: Creates `tutorials/{slug}/index.md` (page bundle)

3. **Create New Documentation**
   - Step 1: Choose category from dropdown (17 options: actuators, cables, sensors, etc.)
   - Step 2: Enter filename (e.g., "przekaznik")
   - Result: Creates `docs/{category}/{filename}.md`

**Usage:** Press `Ctrl+Shift+P` ‚Üí type task name ‚Üí select/enter values

**Inputs configuration:**
- **pickString** for categories (dropdown list, nie trzeba wpisywaƒá rƒôcznie)
- **promptString** for filenames (text input)
- Smart defaults (instalacja, actuators)
- Polish descriptions for better UX
- Uses Hugo's `hugo new content` command under the hood

### Hugo Config Fix

Fixed deprecation warning:
```toml
# OLD (deprecated in Hugo v0.128.0)
paginate = 30

# NEW
[pagination]
  pagerSize = 30
```

**Testing:**

All archetypes tested and working:
```bash
hugo new content blog/test/archetype-test.md           # ‚úÖ Works
hugo new content tutorials/test-tutorial/index.md      # ‚úÖ Works
hugo new content docs/test/test-doc.md                 # ‚úÖ Works
```

**Files Changed:**
- `archetypes/blog.md` - enhanced with Polish context and structure
- `archetypes/tutorials.md` - step-by-step tutorial template
- `archetypes/docs.md` - documentation reference template
- `.vscode/tasks.json` - added 3 content creation tasks with inputs
- `config/_default/hugo.toml` - fixed `paginate` ‚Üí `pagination.pagerSize`

**Benefits:**
1. ‚úÖ Faster content creation via Ctrl+Shift+P
2. ‚úÖ Consistent structure across all content types
3. ‚úÖ Polish language context (categories, tags)
4. ‚úÖ Helpful comments guide content creation
5. ‚úÖ Proper SEO field explanations
6. ‚úÖ No more typing `hugo new content ...` manually

**Commit:** `7c5a17b` - "feat(content): implement Hugo archetypes with Polish templates and VS Code tasks"

---

## 12. Developer Experience Improvements

**Goal:** Improve DX with Dependabot, EditorConfig, nvmrc, and VS Code snippets

### ‚úÖ 1. Related Content - Already Implemented

**Status:** Already working! ‚úì
- Config: `params.toml` ‚Üí `relatedPosts = true`
- Partial: `layouts/partials/sidebar/related-posts.html`
- Shows 3 related posts based on tags, categories, dates
- **No action needed**

### ‚úÖ 2. Dependabot - Auto Dependency Updates

**File:** `.github/dependabot.yml`

**Configuration:**
- **npm updates** (weekly, Monday 9:00 CET)
  - Groups Hyas ecosystem packages together
  - Groups dev dependencies minor/patch updates
  - Max 5 open PRs
- **GitHub Actions updates** (weekly, Monday 9:00 CET)
  - Max 3 open PRs
- Auto-assigns to @zentala
- Labels: `dependencies`, `npm`/`github-actions`
- Commit prefix: `chore(deps)` / `chore(ci)`

**Benefits:**
- ‚úÖ Automatic security patches
- ‚úÖ Stay up-to-date with Hugo, pnpm, dependencies
- ‚úÖ Review changes in PRs before merging
- ‚úÖ Zero manual effort after setup

### ‚úÖ 3. EditorConfig - Consistent Formatting

**File:** `.editorconfig` (improved existing)

**Added rules:**
- Markdown: preserve trailing whitespace (for double-space line breaks)
- PowerShell: Windows line endings (CRLF)
- Batch files: Windows line endings
- Makefile: tab indentation

**Benefits:**
- ‚úÖ Consistent formatting across VS Code, Cursor, other editors
- ‚úÖ No more formatting conflicts
- ‚úÖ Works automatically (all modern editors support it)

### ‚úÖ 4. .nvmrc - Node.js Version Pinning

**File:** `.nvmrc`
**Content:** `v22.11.0`

**Usage:**
```bash
nvm use          # Auto-detects version from .nvmrc
# Or
nvm install      # Installs correct version
```

**Benefits:**
- ‚úÖ Team uses same Node.js version
- ‚úÖ No "works on my machine" issues
- ‚úÖ CI/CD can auto-detect version

### ‚úÖ 5. VS Code Snippets - Hugo Shortcodes

**File:** `.vscode/hugo-snippets.code-snippets`

**Co to sƒÖ snippety?**
Snippety to **szablony kodu** kt√≥re mo≈ºesz wkleiƒá piszƒÖc kr√≥tki prefix. W VS Code:
1. Zacznij pisaƒá prefix (np. `callout-tip`)
2. Naci≈õnij `Tab` lub `Enter`
3. Snippet siƒô rozwinie z placeholderami
4. `Tab` przeskakuje miƒôdzy placeholderami

**Przyk≈Çad u≈ºycia:**

Piszesz w markdown:
```
callout-tip [TAB]
```

Rozwija siƒô do:
```markdown
{{< callout context="tip" title="Wskaz√≥wka" icon="rocket" >}}
[cursor tutaj]
{{< /callout >}}
```

**Dostƒôpne snippety (21 total):**

| Prefix | Co robi |
|--------|---------|
| `callout-note` | Note callout (niebieski) |
| `callout-tip` | Tip callout (zielony) |
| `callout-caution` | Caution callout (≈º√≥≈Çty) |
| `callout-danger` | Danger callout (czerwony) |
| `details` | Collapsible details |
| `details-open` | Details (domy≈õlnie otwarty) |
| `tabs` | Tabs (3 taby) |
| `kroki-d2` | D2 diagram |
| `kroki-mermaid` | Mermaid diagram |
| `kroki-plantuml` | PlantUML diagram |
| `code-title` | Code block z tytu≈Çem |
| `code-lines` | Code block z numerami linii |
| `code-highlight` | Code block z pod≈õwietleniem |
| `img` | Hugo image |
| `picture` | Hugo picture |
| `figure` | Hugo figure z caption |
| `svg` | Tabler icon (inline SVG) |
| `youtube` | YouTube embed |
| `link-card` | Link card |
| `math-inline` | Inline math |
| `math-block` | Math block (centered) |

**Snippety bazujƒÖ na twoim demo.md** - wszystkie shortcody kt√≥re tam sƒÖ, masz teraz jako snippety!

**Benefits:**
- ‚úÖ Szybsze pisanie (bez przepisywania shortcode syntax)
- ‚úÖ Mniej b≈Çƒôd√≥w (syntax zawsze poprawny)
- ‚úÖ Autocomplete podpowiada dostƒôpne snippety
- ‚úÖ Tab navigation miƒôdzy placeholderami

**Files Changed:**
- `.github/dependabot.yml` - NEW
- `.editorconfig` - improved
- `.nvmrc` - NEW
- `.vscode/hugo-snippets.code-snippets` - NEW (21 snippets)

**Commit:** `2accf23` - "feat(dx): add Dependabot, improve EditorConfig, add nvmrc and VS Code snippets"

---

*Runbook created by Claude Code on 2025-10-18*
