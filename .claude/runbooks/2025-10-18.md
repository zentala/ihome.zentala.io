# Runbook - 2025-10-18

## Session Summary
Working on ihome.zentala.io Hugo blog - fixing production issues, optimizing CI/CD, and improving documentation.

---

## 1. Fixed Kroki Diagrams 403 Forbidden Errors in GitHub Actions

**Problem:** Hugo build failing with "failed to fetch remote resource: Forbidden" when fetching diagrams from kroki.io API

**Root Cause:**
- GitHub Actions fetching diagrams on every build
- Rate limiting from kroki.io (100 req/min)
- No persistent cache between builds

**Solution:**
```toml
# config/_default/hugo.toml
[caches.getresource]
  dir = ":resourceDir/_gen"
  maxAge = -1  # Never expire, invalidate on content change
```

**Steps:**
1. Added cache config to `hugo.toml`
2. Updated `.gitignore` to commit `resources/_gen/getresource/`
3. Built locally to generate 54 cached SVG diagrams
4. Committed cached resources to repo

**Result:**
- ‚úÖ GitHub Actions build: 3 errors ‚Üí 0 errors
- ‚úÖ Build time: 50s (stable)
- ‚úÖ No more API calls to kroki.io

**Files Changed:**
- `config/_default/hugo.toml`
- `.gitignore`
- `resources/_gen/getresource/*` (54 cached diagrams)

**Commit:** `4f27114` - "fix(build): cache Kroki diagrams to fix GitHub Actions 403 errors"

---

## 2. Hide Dev-Only Elements in Production

**Problem:** "Markdown Demo" link and draft toggle (eye icon) visible on production site

**Solution:** Use `hugo.Environment` for dev/prod detection

**Implementation:**

### Footer - Demo Link
```toml
# config/_default/menus/menus.pl.toml
[[footer]]
  name = "Markdown Demo"
  url = "/demo/"
  weight = 20
  [footer.params]
    devOnly = true  # Flag for dev-only items
```

```html
<!-- layouts/partials/footer/footer.html -->
{{ range .Site.Menus.footer -}}
  {{- $showLink := true -}}
  {{- if .Params.devOnly -}}
    {{- if eq hugo.Environment "production" -}}
      {{- $showLink = false -}}
    {{- end -}}
  {{- end -}}
  {{- if $showLink -}}
  <li>...</li>
  {{- end -}}
{{- end }}
```

### Header - Draft Toggle
```html
<!-- layouts/partials/header/header.html -->
<!-- Draft toggle (dev only) -->
{{ if ne hugo.Environment "production" -}}
<button type="button" id="draftToggle" class="draft-toggle">
  <!-- eye icon -->
</button>
{{ end -}}
```

**Result:**
- ‚úÖ Demo link hidden on production
- ‚úÖ Draft toggle hidden on production
- ‚úÖ DRY principle - one detection mechanism

**Files Changed:**
- `config/_default/menus/menus.pl.toml`
- `layouts/partials/footer/footer.html`
- `layouts/partials/header/header.html`

**Commit:** `0d1fab5` - "feat: hide dev-only elements in production and update copyright"

---

## 3. Dynamic Copyright Year

**Problem:** Copyright showing "2024" instead of "2004-{current year}"

**Initial Attempt (FAILED):**
```toml
# config/_default/languages.toml
footer = 'Copyright &copy; 2004-{{ now.Year }} ...'
```
‚ùå Hugo template syntax doesn't work in TOML config files!

**Correct Solution:**
```html
<!-- layouts/partials/footer/footer.html -->
<li class="list-inline-item">
  Copyright &copy; 2004-{{ now.Year }}
  <a class="text-muted" href="https://zentala.io/" target="_blank">Pawe≈Ç ≈ªenta≈Ça</a>
</li>
```

**Result:**
- ‚úÖ Shows "Copyright ¬© 2004-2025"
- ‚úÖ Auto-updates every year

**Files Changed:**
- `config/_default/languages.toml` (removed footer param)
- `layouts/partials/footer/footer.html` (added dynamic rendering)

**Commit:** `c874f98` - "fix(footer): render copyright year dynamically in template"

---

## 4. Documentation Refactoring

**Goal:** Separate marketing (README) from developer docs (CONTRIBUTING)

**Changes:**

### README.md (simplified)
- Added link: "This blog" ‚Üí https://ihome.zentala.io/
- Added "AI Development Ready" section
- Moved all technical details to CONTRIBUTING.md
- Fixed typo: "Hays" ‚Üí "Hyas"

### CONTRIBUTING.md (new file)
- Requirements, Quick Start, Commands
- AI Development section:
  - Claude Code - dev/deployment/debugging
  - Cursor IDE - content writing/blog posts
  - VS Code - manual editing
- Workflow recommendations table
- Troubleshooting guide

**Files Changed:**
- `README.md` (shortened from 132 to 31 lines)
- `CONTRIBUTING.md` (new, 120 lines)

**Commit:** `9d909b3` - "docs: refactor documentation structure and add AI development guide"

---

## 5. CI/CD Performance Optimization

**Goal:** Speed up GitHub Actions builds

**Implementation:**
```yaml
# .github/workflows/deploy.yml
- name: Get pnpm store directory
  run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

- name: Setup pnpm cache
  uses: actions/cache@v4
  with:
    path: ${{ env.STORE_PATH }}
    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
    restore-keys: |
      ${{ runner.os }}-pnpm-store-
```

**Expected Result:**
- First build: 50s (creates cache)
- Subsequent builds: 25-30s (uses cache)

**Actual Results:**
- Build #1: 50s (no cache)
- Build #2: 47s (creating cache)
- Build #3: 55s (cache might not have worked due to network)
- Next builds: TBD (cache should work)

**Files Changed:**
- `.github/workflows/deploy.yml`

**Commit:** `8dc14d5` - "perf(ci): add pnpm store cache and document tech improvements"

---

## 6. Tech Improvements Documentation

**Created:** `.cursor/todo/tech-improvements.md`

**Contents:**
- Explanation of Hugo Archetypes (content templates)
- Explanation of Related Content (SEO interlinking)
- Future ideas: Lighthouse CI, Dependabot, ADR
- Priority matrix

**Purpose:** Knowledge base for future improvements

---

## 7. Cleanup & Security

### .gitignore Improvements
```gitignore
# Logs
*.log
*.log.*
gh-action-log.txt

# Local env files
.env.local
.env.*.local

# Downloaded binaries and archives
*.zip
*.tar.gz
*.exe
hugo
hugo.exe
```

**Commits:**
- `3a13bf8` - "chore: improve .gitignore - add log files and local env patterns"
- (pending) - Remove hugo.zip from repo

---

## 8. Hugo.zip Cleanup (In Progress)

**Problem:** 21MB `hugo.zip` file committed in git history (commit 18397b1, Oct 12)

**Steps Taken:**
1. ‚úÖ Removed `hugo.zip` from working directory
2. ‚úÖ Added `*.zip`, `*.tar.gz`, `*.exe`, `hugo`, `hugo.exe` to `.gitignore`
3. ‚è≥ Need to remove from git history using BFG

**TODO:**
```bash
# Option 1: BFG (recommended)
git clone --mirror https://github.com/zentala/ihome.zentala.io.git
bfg --delete-files hugo.zip ihome.zentala.io.git
cd ihome.zentala.io.git
git reflog expire --expire=now --all && git gc --prune=now --aggressive
git push

# Option 2: git filter-repo (alternative)
git filter-repo --path hugo.zip --invert-paths
```

**Why This Matters:**
- 21MB in git history slows down clones
- Unnecessary binary in repo
- Hugo installed via `hugo-installer` package anyway

---

## Key Learnings

1. **Hugo Config Limitations:** Template syntax (`{{ now.Year }}`) doesn't work in TOML config files - must use in templates
2. **Cache Strategy:** For external resources, commit cached files to repo for CI/CD reliability
3. **DRY Detection:** Use `hugo.Environment` for consistent dev/prod detection across all templates
4. **Git Hygiene:** Always check for large files before committing, use .gitignore patterns proactively

---

## Build Performance Tracking

| Date | Commit | Build Time | Cache Status | Notes |
|------|--------|------------|--------------|-------|
| 2025-10-18 | 4f27114 | 50s | No cache | Kroki fix baseline |
| 2025-10-18 | 0d1fab5 | 50s | No cache | Dev elements hidden |
| 2025-10-18 | 8dc14d5 | 47s | Creating | pnpm cache setup |
| 2025-10-18 | c874f98 | 55s | ??? | Copyright fix |

**Target:** 25-30s with pnpm cache working

---

## Files Modified Summary

**Config:**
- `config/_default/hugo.toml` - Kroki cache
- `config/_default/languages.toml` - Removed footer param
- `config/_default/menus/menus.pl.toml` - devOnly flag
- `.gitignore` - Logs, env, binaries

**Templates:**
- `layouts/partials/footer/footer.html` - Dev detection, dynamic copyright
- `layouts/partials/header/header.html` - Dev detection for draft toggle

**Docs:**
- `README.md` - Simplified, marketing focus
- `CONTRIBUTING.md` - New, technical details
- `.cursor/todo/tech-improvements.md` - New, future ideas

**CI/CD:**
- `.github/workflows/deploy.yml` - pnpm cache

**Resources:**
- `resources/_gen/getresource/*` - 54 cached Kroki diagrams

---

## Next Session TODO

1. ‚ö†Ô∏è Remove hugo.zip from git history (BFG or filter-repo)
2. üìä Monitor pnpm cache effectiveness on next build
3. üéØ Consider implementing Hugo Archetypes (see tech-improvements.md)
4. üîó Evaluate Related Content implementation for SEO

---

## 9. Runbook Structure Refactor

**Change:** Moved from nested folders to flat structure

**Before:** `.claude/runbook/2025/10/18.md` (with year/month subfolders)
**After:** `.claude/runbooks/2025-10-18.md` (flat, sortable by filename)

**Reason:**
- Simpler file organization
- Easier to find: just sort by date
- Less directory clutter

**Files Changed:**
- `.claude/CLAUDE.md` - Updated runbook protocol to use `YYYY-MM-DD.md` format
- Moved & updated this runbook file

**Command:**
```bash
mkdir -p .claude/runbooks
mv .claude/runbook/2025/10/18.md .claude/runbooks/2025-10-18.md
rm -rf .claude/runbook
```

---

*Runbook created by Claude Code on 2025-10-18*
